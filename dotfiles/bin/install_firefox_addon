#!/bin/bash
#set -x

function help {
        cat <<HELP
$(basename $0) (-f <FILE>|<URL>)
Automatically Install Extension from URL to Firefox
With '-f' install all Extensions from the URLlist '<FILE>' ('\\n'-seperated)
HELP
exit 0
}

if [[ "$1" = "-f" ]]; then
    if [[ -f "$2" ]]; then
        for url in $(grep -v "^#" $2); do
	    echo "installing $url"
	    $0 "$url"
        done
    else
	help
    fi
    exit 0
fi



EXTENSION=${1%\?*}
if [[ -z "$EXTENSION" ]]; then
    help
fi

NAME=$(basename $EXTENSION .xpi)
TEMPDIR=$(mktemp -d)
OLDPWD=$(pwd)
EXTDIR=~/.mozilla/extensions/
EXTDIR=/usr/lib/firefox-addons/extensions/
cd $TEMPDIR

cleanup() {
    cd $OLDPWD
    rm -fr "$TEMPDIR"
}
trap cleanup 0

error() {
  local parent_lineno="$1"
  local message="$2"
  local code="${3:-1}"
  if [[ -n "$message" ]] ; then
    echo "Error on or near line ${parent_lineno}: ${message}; exiting with status ${code}"
  else
    echo "Error on or near line ${parent_lineno}; exiting with status ${code}"
  fi
  exit "${code}"
}
trap 'error ${LINENO}' ERR


echo "Downloading Firefox Add-on $NAME"
wget -qO "${NAME}.xpi" "$EXTENSION"

if ! file ${NAME}.xpi | grep -q "Zip archive data"; then
  error ${LINENO} "${NAME}.xpi does not look like an Zip Archive" 2
fi

metadatafile=$(unzip -l ${NAME}.xpi  |grep "install.rdf\|manifest.json" | sed 's/.* //')

case $metadatafile in
  install.rdf)
    # Getting ID from install.rdf
    ID=$(unzip -p ${NAME}.xpi install.rdf |sed -nr 's#.*id>(.*)</(em:)*id.*#\1#p'|head -1)
    ;;
  manifest.json)
    # Getting ID from mainfest.json
    ID=$(unzip -p ${NAME}.xpi manifest.json |jq -r "..|.gecko?.id? |select(. != null)" )
    ;;
  *)
    error ${LINENO} "Can not discern Extention ID (neither install.rdf not manifest.json found)" 3
    exit 1
    ;;
esac

#unzip -q ${NAME}.xpi -d $ID
ID=${ID}.xpi
mv ${NAME}.xpi $ID

if [[ -e ${EXTDIR}/${ID} ]]; then
    read -p "Add-on directory exists. overwrite? Y/N" -i N -n 1 -t 10 answer
    echo ""
    if [[ "${answer,,}" != "y" ]]; then
        echo "Add-on exists and no overwrite requested. Exiting."
        exit 0
    fi
    rm -r ${EXTDIR}/${ID}
fi
echo "Installing $NAME to ${EXTDIR}/${ID}"
sudo mv ${ID} ${EXTDIR}/${ID}

